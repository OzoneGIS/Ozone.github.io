<html>

<head>
  <meta charset="utf-8">
  <title>Ozone</title>
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
  <link href='./src/styles/index.css' type="text/css" rel="stylesheet" />

</head>

<body>
  <div class='sidebar'>
    <div class="heading">
      <h1>Water Refill Stations</h1>
    </div>
    <div id="listings" class="listings"></div>
  </div>

  <div id='map' class='map'></div>

  <script>
    // This will let you use the .remove() function later on
    if (!('remove' in Element.prototype)) {
      Element.prototype.remove = function() {
        if (this.parentNode) {
          this.parentNode.removeChild(this);
        }
      };
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoiYWRhcmlhbiIsImEiOiJjajJvYWkzbncwMnRtMnJtaXljZjkzZm1tIn0.dadJW7Lq3wuEU6jr8B2Rcg';

    var bounds = [
      [-120.434492, 37.360587], //Southwest coordinates
      [-120.417969, 37.373377], //Northeast coordinates
    ];

    // This adds the map to your page
    var map = new mapboxgl.Map({
      // container id specified in the HTML
      container: 'map',
      // style URL
      style: 'mapbox://styles/mapbox/light-v9',
      // initial position in [lon, lat] format
      center: [-120.4295379, 37.3634714],
      // initial zoom
      zoom: 17,
      maxBounds: bounds,
    });

    var water = {
      "type": "FeatureCollection",
      "features": [{
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4295379, 37.3634714],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4298095, 37.3638236],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4296546, 37.3642097],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4294038, 37.3642779],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4294095, 37.3642766],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.42945651, 37.3675824],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.427814, 37.364143],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.426924, 37.364605],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.426837, 37.365075],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.427697, 37.365323],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.426142, 37.365323],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.426142, 37.365181],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.426955, 37.365905],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4301343, 37.3640383],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4249661, 37.3662876],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4244122, 37.3663140],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4244561, 37.3670241],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4234681, 37.3669634],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4228461, 37.3676064],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4219516, 37.3673346],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4222021, 37.3663892],
          }
        },
        {
          "type": "Feature",
          "properties": {
            "title": "Water Refill Station",
            "description": "Description to be added...",
            "icon": "star",
          },
          "geometry": {
            "type": "Point",
            "coordinates": [-120.4216203, 37.3659548],
          }
        }
      ],
    };

    map.on('load', function(e) {
      // Add the data to your map as a layer
      map.addLayer({
        "id": "locations",
        "type": "symbol",
        // Add a GeoJSON source containing place coordinates and information.
        "source": {
          "type": "geojson",
          "data": water
        },
        'layout': {
          'icon-image': 'marker-15',
          'icon-allow-overlap': true,
        }
      });
      buildLocationList(water);
    });

    map.on('click', function(e) {
      var features = map.queryRenderedFeatures(e.point, {
        layers: ['locations']
      });
      if (features.length) {
        var clickedPoint = features[0];
        flyToStore(clickedPoint);
        createPopUp(clickedPoint);
        var activeItem = document.getElementsByClassName('active');
        if (activeItem[0]) {
          activeItem[0].classList.remove('active');
        }
        var selectedFeature = clickedPoint.properties.title;
        for (var i = 0; i < stores.features.length; i++) {
          if (stores.features[i].properties.description === selectedFeature) {
            selectedFeatureIndex = i;
          }
        }
        var listing = document.getElementById('listing-' + selectedFeatureIndex);
        listing.classList.add('active');
      }
    });

    function flyToStore(currentFeature) {
      map.flyTo({
        center: currentFeature.geometry.coordinates,
        zoom: 17
      });
    }

    function createPopUp(currentFeature) {
      var popUps = document.getElementsByClassName('mapboxgl-popup');
      if (popUps[0]) popUps[0].remove();
      var popup = new mapboxgl.Popup({
          closeOnClick: true,
        })
        .setLngLat(currentFeature.geometry.coordinates)
        .setHTML('<h3>Water Refill Station</h3>' +
          '<h4>' + currentFeature.properties.description + '</h4>')
        .addTo(map);
    }

    function buildLocationList(data) {
      for (i = 0; i < data.features.length; i++) {
        var currentFeature = data.features[i];
        var prop = currentFeature.properties;
        var listings = document.getElementById('listings');
        var listing = listings.appendChild(document.createElement('div'));
        listing.className = 'item';
        listing.id = 'listing-' + i;
        var link = listing.appendChild(document.createElement('a'));
        link.href = '#';
        link.className = 'titles';
        link.dataPosition = i;
        link.innerHTML = prop.title;
        var details = listing.appendChild(document.createElement('div'));
        details.innerHTML = prop.description;
        link.addEventListener('click', function(e) {
          var clickedListing = data.features[this.dataPosition];
          flyToStore(clickedListing);
          createPopUp(clickedListing);
          var activeItem = document.getElementsByClassName('active');
          if (activeItem[0]) {
            activeItem[0].classList.remove('active');
          }
          this.parentNode.classList.add('active');
        });
      }
    }
  </script>
</body>

</html>
